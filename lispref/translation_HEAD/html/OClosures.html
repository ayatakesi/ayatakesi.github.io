<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Created by GNU Texinfo 6.8, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This is the GNU Emacs Lisp Reference Manual
corresponding to Emacs version 27.1.

Copyright (C) 1990-1996, 1998-2022 Free Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.3 or any later
version published by the Free Software Foundation; with the Invariant
Sections being "GNU General Public License," with the Front-Cover Texts
being "A GNU Manual," and with the Back-Cover Texts as in (a) below.  A
copy of the license is included in the section entitled "GNU Free
Documentation License."

(a) The FSF's Back-Cover Text is: "You have the freedom to copy and modify
this GNU manual.  Buying copies from the FSF supports it in developing GNU
and promoting software freedom." -->
<title>OClosures (GNU Emacs Lisp Reference Manual)</title>

<meta name="description" content="OClosures (GNU Emacs Lisp Reference Manual)">
<meta name="keywords" content="OClosures (GNU Emacs Lisp Reference Manual)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="texi2any">
<meta name="date" content="January 7, 2023">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Index.html" rel="index" title="Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Functions.html" rel="up" title="Functions">
<link href="Advising-Functions.html" rel="next" title="Advising Functions">
<link href="Closures.html" rel="prev" title="Closures">
<style type="text/css">
<!--
a.copiable-anchor {visibility: hidden; text-decoration: none; line-height: 0em}
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
span:hover a.copiable-anchor {visibility: visible}
ul.no-bullet {list-style: none}
-->
</style>


</head>

<body lang="en">
<div class="section" id="OClosures">
<div class="header">
<p>
Next: <a href="Advising-Functions.html" accesskey="n" rel="next">Emacs Lisp関数にたいするアドバイス</a>, Previous: <a href="Closures.html" accesskey="p" rel="prev">クロージャー</a>, Up: <a href="Functions.html" accesskey="u" rel="up">関数</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<span id="Open-Closures"></span><h3 class="section">13.11 Open Closures</h3>

<p>Traditionally, functions are opaque objects which offer no other
functionality but to call them.  Emacs Lisp functions aren&rsquo;t fully opaque
since you can extract some info out of them such as their docstring, their
arglist, or their interactive spec, but they are mostly opaque.  This is
usually what we want, but occasionally we need functions to expose a bit
more information about themselves.
</p>
<p>OClosures are functions which carry additional type information, and expose
some information in the form of slots which you can access via accessor
functions.
</p>
<p>They are defined in two steps: first <code>oclosure-define</code> is used to
define new OClosure types by specifying the slots carried by those
OClosures, and then <code>oclosure-lambda</code> is used to create an OClosure
object of a given type.
</p>
<p>Say we want to define keyboard macros, i.e. interactive functions which
re-execute a sequence of key events.  You could do it with a plain function
as follows:
</p><div class="example">
<pre class="example">(defun kbd-macro (key-sequence)
  (lambda (&amp;optional arg)
    (interactive &quot;P&quot;)
    (execute-kbd-macro key-sequence arg)))
</pre></div>
<p>But with such a definition there is no easy way to extract the
<var>key-sequence</var> from that function, for example to print it.
</p>
<p>We can solve this problem using OClosures as follows.  First we define the
type of our keyboard macros (to which we decided to add a <code>counter</code>
slot while at it):
</p><div class="example">
<pre class="example">(oclosure-define kbd-macro
  &quot;Keyboard macro.&quot;
  keys (counter :mutable t))
</pre></div>
<p>After which we can rewrite our <code>kbd-macro</code> function:
</p><div class="example">
<pre class="example">(defun kbd-macro (key-sequence)
  (oclosure-lambda (kbd-macro (keys key-sequence) (counter 0))
      (&amp;optional arg)
    (interactive &quot;p&quot;)
    (execute-kbd-macro keys arg)
    (setq counter (1+ counter))))
</pre></div>
<p>As you can see, the <code>keys</code> and <code>counter</code> slots of the OClosure can
be accessed as local variables from within the body of the OClosure.  But we
can now also access them from outside of the body of the OClosure, for
example to describe a keyboard macro:
</p><div class="example">
<pre class="example">(defun describe-kbd-macro (km)
  (if (not (eq 'kbd-macro (oclosure-type km)))
      (message &quot;Not a keyboard macro&quot;)
    (let ((keys    (kbd-macro--keys km))
          (counter (kbd-macro--counter km)))
      (message &quot;Keys=%S, called %d times&quot; keys counter))))
</pre></div>
<p>Where <code>kbd-macro--keys</code> and <code>kbd-macro--counter</code> are accessor
functions generated by the <code>oclosure-define</code> macro.
</p>
<dl class="def">
<dt id="index-oclosure_002ddefine"><span class="category">Macro: </span><span><strong>oclosure-define</strong> <em>name &amp;optional docstring &amp;rest slots</em><a href='#index-oclosure_002ddefine' class='copiable-anchor'> &para;</a></span></dt>
<dd><p>This macro defines a new OClosure type along with accessor functions for its
slots.  <var>name</var> can be a symbol (the name of the new type), or a list of
the form <code>(<var>name</var> . <var>type-props</var>)</code> in which case
<var>type-props</var> is a list of additional properties.  <var>slots</var> is a list
of slot descriptions where each slot can be either a symbol (the name of the
slot) or it can be of the form <code>(<var>slot-name</var> . <var>slot-props</var>)</code>
where <var>slot-props</var> is a property list.
</p>
<p>For each slot, the macro creates an accessor function named
<code><var>name</var>--<var>slot-name</var></code>.  By default slots are immutable.  If you
need a slot to be mutable, you need to specify it with the <code>:mutable</code>
slot property, after which it can be mutated for example with <code>setf</code>.
</p>
<p>Beside slot accessors, the macro can create a predicate and functional
update functions according to <var>type-props</var>: a <code>(:predicate
<var>pred-name</var>)</code> in the <var>type-props</var> causes the definition of a
predicate function under the name <var>pred-name</var>, and <code>(:copier
<var>copier-name</var> <var>copier-arglist</var>)</code> causes the definition of a
functional update function which takes an OClosure of type <var>name</var> as
first argument and returns a copy of it with the slots named in
<var>copier-arglist</var> modified to the value passed in the corresponding
argument.
</p></dd></dl>

<dl class="def">
<dt id="index-oclosure_002dlambda"><span class="category">Macro: </span><span><strong>oclosure-lambda</strong> <em>(type . slots) arglist &amp;rest body</em><a href='#index-oclosure_002dlambda' class='copiable-anchor'> &para;</a></span></dt>
<dd><p>This macro creates an anonymous OClosure of type <var>type</var>.  <var>slots</var>
should be a list of elements of the form <code>(<var>slot-name</var>
<var>exp</var>)</code>.  At run time, each <var>exp</var> is evaluated, in order, after
which the OClosure is created with its slots initialized with the resulting
values.
</p>
<p>When called as a function, the OClosure will accept arguments according to
<var>arglist</var> and will execute the code in <var>body</var>.  <var>body</var> can refer
to the value of any of its slot directly as if it were a local variable that
had been captured by static scoping.
</p></dd></dl>

<dl class="def">
<dt id="index-oclosure_002dtype"><span class="category">Function: </span><span><strong>oclosure-type</strong> <em>object</em><a href='#index-oclosure_002dtype' class='copiable-anchor'> &para;</a></span></dt>
<dd><p>This function returns the OClosure type (a symbol) of <var>object</var> if it is
an OClosure, and <code>nil</code> otherwise.
</p></dd></dl>


</div>
<hr>
<div class="header">
<p>
Next: <a href="Advising-Functions.html">Emacs Lisp関数にたいするアドバイス</a>, Previous: <a href="Closures.html">クロージャー</a>, Up: <a href="Functions.html">関数</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>


This page has generated for branch:work/emacs-29_edd64e64a389e0f0e6ce670846d4fae79a9d8b35, commit:0dc0a3f545c069bb6447c4e26cf32c31331b9e10 to check Japanese translation.
</body>
</html>
