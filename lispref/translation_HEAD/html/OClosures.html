<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Created by GNU Texinfo 6.8, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This is the GNU Emacs Lisp Reference Manual
corresponding to Emacs version 29.1.

Copyright (C) 1990-1996, 1998-2023 Free Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.3 or any later
version published by the Free Software Foundation; with the Invariant
Sections being "GNU General Public License," with the Front-Cover Texts
being "A GNU Manual," and with the Back-Cover Texts as in (a) below.  A
copy of the license is included in the section entitled "GNU Free
Documentation License."

(a) The FSF's Back-Cover Text is: "You have the freedom to copy and modify
this GNU manual.  Buying copies from the FSF supports it in developing GNU
and promoting software freedom." -->
<title>OClosures (GNU Emacs Lisp Reference Manual)</title>

<meta name="description" content="OClosures (GNU Emacs Lisp Reference Manual)">
<meta name="keywords" content="OClosures (GNU Emacs Lisp Reference Manual)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="texi2any">
<meta name="date" content="August 2, 2023">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Index.html" rel="index" title="Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Functions.html" rel="up" title="Functions">
<link href="Advising-Functions.html" rel="next" title="Advising Functions">
<link href="Closures.html" rel="prev" title="Closures">
<style type="text/css">
<!--
a.copiable-anchor {visibility: hidden; text-decoration: none; line-height: 0em}
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
span:hover a.copiable-anchor {visibility: visible}
ul.no-bullet {list-style: none}
-->
</style>


</head>

<body lang="en">
<div class="section" id="OClosures">
<div class="header">
<p>
Next: <a href="Advising-Functions.html" accesskey="n" rel="next">Emacs Lisp関数にたいするアドバイス</a>, Previous: <a href="Closures.html" accesskey="p" rel="prev">クロージャー</a>, Up: <a href="Functions.html" accesskey="u" rel="up">関数</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<span id="opunkuroziya"></span><h3 class="section">13.11 オープンクロージャー</h3>
<span id="index-oclosures"></span>
<span id="index-open-closures"></span>

<p>Traditionally, functions are opaque objects which offer no other
functionality but to call them.  (Emacs Lisp functions aren&rsquo;t fully opaque
since you can extract some info out of them such as their docstring, their
arglist, or their interactive spec, but they are still mostly opaque.)  This
is usually what we want, but occasionally we need functions to expose a bit
more information about themselves.
</p>
<p><em>Open closures</em>, or <em>OClosures</em> for short, are function objects
which carry additional type information and expose some information about
themselves in the form of slots which you can access via accessor functions.
</p>
<p>OClosures are defined in two steps: first you use <code>oclosure-define</code> to
define a new OClosure type by specifying the slots carried by the OClosures
of this type, and then you use <code>oclosure-lambda</code> to create an OClosure
object of a given type.
</p>
<p>Let&rsquo;s say we want to define keyboard macros, i.e. interactive functions
which re-execute a sequence of key events (see <a href="Keyboard-Macros.html">キーボードマクロ</a>).  You
could do it with a plain function as follows:
</p>
<div class="example">
<pre class="example">(defun kbd-macro (key-sequence)
  (lambda (&amp;optional arg)
    (interactive &quot;P&quot;)
    (execute-kbd-macro key-sequence arg)))
</pre></div>

<p>しかしこのような定義では関数から<var>key-sequence</var>を抽出して、たとえばプリントするといったようなことを簡単に行う方法はありません。
</p>
<p>この問題は以下のようなOClosureを使えば解決できます。まずはキーボードマクロのタイプを定義します(ついでに<code>counter</code>スロットを追加することにします):
</p>
<div class="example">
<pre class="example">(oclosure-define kbd-macro
  &quot;Keyboard macro.&quot;
  keys (counter :mutable t))
</pre></div>

<p>その後に<code>kbd-macro</code>関数の定義を書き換えることができます:
</p>
<div class="example">
<pre class="example">(defun kbd-macro (key-sequence)
  (oclosure-lambda (kbd-macro (keys key-sequence) (counter 0))
      (&amp;optional arg)
    (interactive &quot;P&quot;)
    (execute-kbd-macro keys arg)
    (setq counter (1+ counter))))
</pre></div>

<p>ご覧のとおり、このOClosureのスロット<code>keys</code>と<code>counter</code>には、OClosureのbodyからローカル変数としてアクセスすることができます。しかしOClosureのbody外部からもアクセスできるようになったのです。たとえばキーボードマクロをdescribeする関数は:
</p>
<div class="example">
<pre class="example">(defun describe-kbd-macro (km)
  (if (not (eq 'kbd-macro (oclosure-type km)))
      (message &quot;Not a keyboard macro&quot;)
    (let ((keys    (kbd-macro--keys km))
          (counter (kbd-macro--counter km)))
      (message &quot;Keys=%S, called %d times&quot; keys counter))))
</pre></div>

<p>Where <code>kbd-macro--keys</code> and <code>kbd-macro--counter</code> are accessor
functions generated by the <code>oclosure-define</code> macro for oclosures whose
type is <code>kbd-macro</code>.
</p>
<dl class="def">
<dt id="index-oclosure_002ddefine"><span class="category">Macro: </span><span><strong>oclosure-define</strong> <em>oname &amp;optional docstring &amp;rest slots</em><a href='#index-oclosure_002ddefine' class='copiable-anchor'> &para;</a></span></dt>
<dd><p>This macro defines a new OClosure type along with accessor functions for its
<var>slots</var>.  <var>oname</var> can be a symbol (the name of the new type), or a
list of the form <code>(<var>oname</var>&nbsp;.&nbsp;<var><span class="nolinebreak">type-props</span></var>)</code><!-- /@w -->, in which case
<var>type-props</var> is a list of additional properties of this oclosure type.
<var>slots</var> is a list of slot descriptions where each slot can be either a
symbol (the name of the slot) or it can be of the form
<code>(<var><span class="nolinebreak">slot-name</span></var>&nbsp;.&nbsp;<var><span class="nolinebreak">slot-props</span></var>)</code><!-- /@w -->, where <var>slot-props</var> is a
property list of the corresponding slot <var>slot-name</var>.  The OClosure
type&rsquo;s properties specified by <var>type-props</var> can include the following:
</p>
<dl compact="compact">
<dt><span><code>(:predicate <var>pred-name</var>)</code></span></dt>
<dd><p>This requests creation of a predicate function named <var>pred-name</var>.  This
function will be used to recognize OClosures of the type <var>oname</var>.  If
this type property is not specified, <code>oclosure-define</code> will generate a
default name for the predicate.
</p></dd>
<dt><span><code>(:parent <var>otype</var>)</code></span></dt>
<dd><p>This makes type <var>otype</var> of OClosures be the parent of the type
<var>oname</var>.  The OClosures of type <var>oname</var> inherit the <var>slots</var>
defined by their parent type.
</p></dd>
<dt><span><code>(:copier <var>copier-name</var> <var>copier-args</var>)</code></span></dt>
<dd><p>This causes the definition of a functional update function, knows as the
<em>copier</em>, which takes an OClosure of type <var>oname</var> as its first
argument and returns a copy of it with the slots named in <var>copier-args</var>
modified to contain the value passed in the corresponding argument in the
actual call to <var>copier-name</var>.
</p></dd>
</dl>

<p>For each slot in <var>slots</var>, the <code>oclosure-define</code> macro creates an
accessor function named <code><var>oname</var>--<var>slot-name</var></code>; these can be
used to access the values of the slots.  The slot definitions in <var>slots</var>
can specify the following properties of the slots:
</p>
<dl compact="compact">
<dt><span><code>:mutable <var>val</var></code></span></dt>
<dd><p>By default, slots are immutable, but if you specify the <code>:mutable</code>
property with a non-<code>nil</code> value, the slot can be mutated, for example
with <code>setf</code> (see <a href="Setting-Generalized-Variables.html"><code>setf</code>マクロ</a>).
</p></dd>
<dt><span><code>:type <var>val-type</var></code></span></dt>
<dd><p>This specifies the type of the values expected to appear in the slot.
</p></dd>
</dl>
</dd></dl>

<dl class="def">
<dt id="index-oclosure_002dlambda"><span class="category">Macro: </span><span><strong>oclosure-lambda</strong> <em>(type . slots) arglist &amp;rest body</em><a href='#index-oclosure_002dlambda' class='copiable-anchor'> &para;</a></span></dt>
<dd><p>This macro creates an anonymous OClosure of type <var>type</var>, which should
have been defined with <code>oclosure-define</code>.  <var>slots</var> should be a list
of elements of the form <code>(<var><span class="nolinebreak">slot-name</span></var>&nbsp;<var>expr</var>)</code><!-- /@w -->.  At run
time, each <var>expr</var> is evaluated, in order, after which the OClosure is
created with its slots initialized with the resulting values.
</p>
<p>When called as a function (see <a href="Calling-Functions.html">関数の呼び出し</a>), the OClosure created
by this macro will accept arguments according to <var>arglist</var> and will
execute the code in <var>body</var>.  <var>body</var> can refer to the value of any of
its slot directly as if it were a local variable that had been captured by
static scoping.
</p></dd></dl>

<dl class="def">
<dt id="index-oclosure_002dtype"><span class="category">Function: </span><span><strong>oclosure-type</strong> <em>object</em><a href='#index-oclosure_002dtype' class='copiable-anchor'> &para;</a></span></dt>
<dd><p>この関数は<var>object</var>がOClosureであればそのOClosureタイプ(シンボル)そうでなければ<code>nil</code>をリターンする。
</p></dd></dl>

<p>One other function related to OClosures is <code>oclosure-interactive-form</code>,
which allows some types of OClosures to compute their interactive forms
dynamically.  See <a href="Using-Interactive.html">oclosure-interactive-form</a>.
</p>

</div>
<hr>
<div class="header">
<p>
Next: <a href="Advising-Functions.html">Emacs Lisp関数にたいするアドバイス</a>, Previous: <a href="Closures.html">クロージャー</a>, Up: <a href="Functions.html">関数</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>


This page has generated for branch:work/emacs-29_c2d95dd00e6cb0abaf4e7550f38c8c2c9ca22f2d, commit:c8a5a0ddc507591a2c77aad4df5433ca4c40834a to check Japanese translation.
</body>
</html>
